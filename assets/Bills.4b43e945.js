import{c4 as ge,r as c,c as be,aI as u,a5 as C,u as S,P as i,a3 as _,bb as a,b as he,d as t,bE as m,bD as T,a6 as n,ac as r,a4 as y,F as we,aO as ke,M as X,aL as Ce,aJ as Se}from"./index.248bff09.js";import{Q as H}from"./QBtnGroup.d2562c19.js";import{Q as K}from"./QInput.bd7f851f.js";import{Q as qe,a as Z,p as Pe,d as $,b as ee,c as le}from"./paginations.fae28654.js";import{Q as R}from"./QToolbar.34f0bbd6.js";import{Q as Y}from"./QSeparator.fc34b7a9.js";import{Q as z}from"./QBadge.00574bee.js";import{p as te,n as ae,o as g}from"./rtl.ecb27788.js";import{Q as N,a as j}from"./QCard.863ff589.js";import{a as Qe}from"./use-quasar.f0e5aaaf.js";import{u as xe}from"./sale-store.4321e753.js";import{u as Ve}from"./product-store.49bca16a.js";import{u as Be}from"./payment-mode-store.5c8ccbed.js";import{a as $e,u as G}from"./index.ff4c0bc9.js";import{p as Ne}from"./print.15699711.js";import"./use-dark.cfee1f79.js";import"./module_calls.421761b7.js";import"./helpers.73a7253f.js";import"./_commonjsHelpers.6150b38b.js";const Ae=(b,p)=>{const A=b.reduce((I,P)=>I+P.total,0);return`<div style="text-align: center; padding: 10px; border: 1px solid grey; paddinng: 5px; margin-bottom: 20px; width: 100%">
    <h1>${p.title}</h1>
    <ul>
      <li>Total Cost : ${A}</li>
      <li>Payment Mode : ${p.payment_mode}</li>
      <li>Status : ${p.status}</li>
      <li>Created By : ${p.user}</li>
      <li>Created On : ${p.created_at}</li>
      </li>
    </ul>
  </div>`},Ie=(b,p,A)=>{const x=Ae(b,A);Ne({header:x,printable:b,properties:p,type:"json",gridHeaderStyle:"font-weight: bold; border: 2px solid;",gridStyle:"border-collapse: collapse; border: 1px solid;"})};const q=b=>(Ce("data-v-d14d4814"),b=b(),Se(),b),De={class:"q-pa-md"},Ue={key:0},Ee={key:1},Le={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Me={key:1,class:"text-center"},Te={class:"text-center"},ze=q(()=>n("br",null,null,-1)),Fe=q(()=>n("br",null,null,-1)),Oe={key:0},He=q(()=>n("hr",null,null,-1)),Ke={key:1},Re=q(()=>n("hr",null,null,-1)),Ye=q(()=>n("hr",null,null,-1)),je=q(()=>n("b",null,"Add Product",-1)),Ge={key:0},Je=q(()=>n("hr",null,null,-1)),We={class:"text-center error_msg"},Xe=q(()=>n("div",{class:"text-h6"},"Make Payment",-1)),Ze={class:"q-mt-sm"},el={class:"text-center error_msg"},ll={__name:"Bills",setup(b){const p=$e(),A=Qe(),x=Pe(10),I=c(""),P=xe(),se=Ve(),oe=Be(),w=c(!1),D=c(!0),U=c(!1),h=c(1),V=c(1),f=c(""),d=c(""),E=c(""),k=c(""),B=c([]),L=c([]),{data:F,isLoading:ue,isError:J}=G("bills",()=>P.fetchBills(),{onSuccess:s=>{L.value=s.map(l=>({user:l.user,uuid:l.uuid,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});G("products",()=>se.fetchProducts(),{onSuccess:s=>{B.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:ne}=G("payment_modes",()=>oe.fetchPaymentModes()),O=c(B.value),ie=s=>{f.value=s,w.value=!0},M=be(()=>{let s=0;return f.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),re=s=>{f.value=s,U.value=!0},de=()=>{k.value="",w.value=!1,d.value="",h.value=1,k.value=""},ce=async()=>{if(f.value.sales.some(s=>s.name===d.value.name))k.value="Product already added to the bill",v("Product already added to the bill","red","top-right");else if(h.value>d.value.quantity)k.value=`${h.value} is more than the maximum available quantity`,v(`${h.value} is more than the maximum available quantity`,"red","top");else{const s=await P.addProductToBill({bill_uuid:f.value.uuid,uuid:d.value.uuid,name:d.value.name,selling_price:d.value.price,quantity:h.value});s.status=="success"?(p.refetchQueries("bills"),f.value="",w.value=!1,v(s.message,"green","top")):(f.value="",w.value=!1,v(s.message,"red","top"))}},me=()=>{U.value=!1},pe=async s=>{if(confirm("Are you sure?")){const e=await P.removeProductFromBill({product_uuid:s.uuid});e.status=="success"?(p.refetchQueries("bills"),v(e.message,"green","top")):(f.value="",w.value=!1,v(e.message,"red","top"))}},_e=async s=>{if(confirm("Are you sure?")){const e=await P.deleteBill({bill_uuid:s.uuid});e.status=="success"?(p.refetchQueries("bills"),v(e.message,"green","top")):(f.value="",w.value=!1,v(e.message,"red","top"))}},fe=async()=>{let s=[];f.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:f.value.uuid,products:s,payment_mode_uuid:E.value.uuid,bill_status:"sold"};if(D.value?(l.selling_price=Number(M.value),l.actual_selling_price=Number(M.value)):(l.selling_price=Number(M.value),l.actual_selling_price=Number(V.value)),l.actual_selling_price&&l.payment_mode_uuid){const e=await P.updateSaleOperation(l);e.status==="success"?(p.refetchQueries("bills"),E.value="",h.value="",U.value=!1,v(e.message,"green","top")):(k.value=e.message,v(e.message,"red","top-right"))}else k.value="Name is required!",v("Name is required!","red","top-right")},ve=(s,l)=>{s.length>0&&(B.value.includes(s)||B.value.push(s),l(s,"toggle"))},ye=(s,l)=>{l(()=>{if(s==="")O.value=B.value;else{const e=s.toLowerCase();O.value=B.value.filter(o=>o.name.toLowerCase().indexOf(e)>-1)}})},W=s=>{const l=[];s.sales.forEach(o=>{l.push({name:o.name,quantity:o.quantity,price:o.selling_price,total:o.quantity*o.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Ie(l,["name","quantity","price","total"],e)},v=(s,l,e)=>{A.notify({message:s,color:l,position:e})};return(s,l)=>(u(),C("div",De,[S(ue)?(u(),C("div",Ue,"Loading bills...")):S(J)?(u(),C("div",Ee,"An error has occurred: "+i(S(J)),1)):(u(),_(qe,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:L.value,"row-key":"user",filter:I.value,pagination:S(x),"onUpdate:pagination":l[4]||(l[4]=e=>he(x)?x.value=e:null)},{"top-right":a(()=>[t(H,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(m,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=e=>{var o;return L.value=(o=S(F))==null?void 0:o.filter(Q=>Q)})}),t(m,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var o;return L.value=(o=S(F))==null?void 0:o.filter(Q=>Q.status==="sold")})}),t(m,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var o;return L.value=(o=S(F))==null?void 0:o.filter(Q=>Q.status==="pending")})})]),_:1}),t(K,{dense:"",debounce:"300",outlined:"",modelValue:I.value,"onUpdate:modelValue":l[3]||(l[3]=e=>I.value=e),placeholder:"Search"},{append:a(()=>[t(T,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[n("div",Le,[t(j,{bordered:"",class:X(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[t(N,null,{default:a(()=>[e.row.status==="pending"?(u(),_(R,{key:0},{default:a(()=>[n("strong",null,[t(T,{name:"description"}),r(" Created by : "+i(e.row.user),1)]),t($),t(H,null,{default:a(()=>[t(m,{round:"",size:"sm",color:"blue",icon:"add",onClick:o=>ie(e.row)},null,8,["onClick"]),t(m,{size:"sm",round:"",color:"red",icon:"delete",onClick:o=>_e(e.row)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)):(u(),C("div",Me,[n("strong",null,[t(T,{name:"description"}),r(" Created by : "+i(e.row.user),1)]),t($)])),t(Y,{class:"q-mb-sm"}),n("div",Te,[n("small",null,"Created On : "+i(e.row.created_at),1),r(),ze,n("small",null,[t(z,{color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[r("Status : "+i(e.row.status)+" ",1),Fe,r(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"])])]),t(Y,{class:"q-mb-sm"}),n("small",null,[t(te,{dense:"",bordered:"",separator:"",class:"bill"},{default:a(()=>[t(ae,null,{default:a(()=>[t(g,null,{default:a(()=>[r("Name")]),_:1}),t(g,null,{default:a(()=>[r("Price")]),_:1}),t(g,{style:{color:"white"}},{default:a(()=>[r("Quantity")]),_:1}),t(g,{style:{color:"white"}},{default:a(()=>[r("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(u(),_(g,{key:0},{default:a(()=>[r("Action")]),_:1})):y("",!0)]),_:2},1024)]),_:2},1024)]),t(te,{dense:"",bordered:"",separator:""},{default:a(()=>[(u(!0),C(we,null,ke(e.row.sales,(o,Q)=>(u(),_(ae,{key:Q},{default:a(()=>[t(g,null,{default:a(()=>[r(i(o.name),1)]),_:2},1024),t(g,null,{default:a(()=>[r(i(o.selling_price),1)]),_:2},1024),t(g,null,{default:a(()=>[r(i(o.quantity),1)]),_:2},1024),t(g,null,{default:a(()=>[r(i(o.quantity*o.selling_price),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(u(),_(g,{key:0},{default:a(()=>[t(T,{name:"delete",color:"red",onClick:tl=>pe(o),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):y("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),t(Y),t(N,{class:"flex flex-center"},{default:a(()=>[e.row.status==="sold"?(u(),C("b",Oe,"Expected Price Ksh "+i(e.row.selling_price),1)):y("",!0),He,e.row.status==="sold"?(u(),C("b",Ke,"Actual Price Ksh "+i(e.row.actual_selling_price),1)):y("",!0),Re]),_:2},1024),Ye,t(N,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(u(),_(m,{key:0,class:"full-width",dense:"",flat:"",onClick:o=>W(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"])):(u(),_(H,{key:1,push:"",class:"full-width"},{default:a(()=>[t(m,{class:"full-width",dense:"",flat:"",onClick:o=>W(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(m,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:o=>re(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),t(Z,{modelValue:w.value,"onUpdate:modelValue":l[7]||(l[7]=e=>w.value=e),persistent:""},{default:a(()=>[t(j,{style:{width:"500px"}},{default:a(()=>[t(N,null,{default:a(()=>[t(R,null,{default:a(()=>[je,t($),d.value?(u(),C("small",Ge,[t(z,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Price: "+i(d.value.price),1)]),_:1}),t(z,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Category: "+i(d.value.category),1)]),_:1}),t(z,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Department: "+i(d.value.department),1)]),_:1})])):y("",!0)]),_:1}),Je,t(ee,{dense:"","use-input":"",outlined:"",modelValue:d.value,"onUpdate:modelValue":l[5]||(l[5]=e=>d.value=e),"input-debounce":"0",onNewValue:ve,options:O.value,onFilter:ye,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t(N,{class:"q-pt-none"},{default:a(()=>[d.value?(u(),_(K,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:h.value,"onUpdate:modelValue":l[6]||(l[6]=e=>h.value=e),type:"number",hint:`Note : You can sale a maximum of ${d.value.quantity}`},null,8,["modelValue","hint"])):y("",!0)]),_:1}),n("div",We,[n("small",null,i(k.value),1)]),t(le,{align:"right"},{default:a(()=>[t(m,{flat:"",label:"Cancel",color:"red",onClick:de}),t($),h.value&&d.value?(u(),_(m,{key:0,flat:"",label:"Add Product",color:"primary",onClick:ce})):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Z,{modelValue:U.value,"onUpdate:modelValue":l[11]||(l[11]=e=>U.value=e),persistent:""},{default:a(()=>[t(j,{style:{width:"500px"}},{default:a(()=>[t(R,null,{default:a(()=>[Xe,t($),n("small",Ze,[t(m,{size:"sm",color:"blue",depressed:"",class:X(`${D.value?"":"actual_selling_price"}`),onClick:l[8]||(l[8]=e=>D.value=!D.value),label:`Expected Selling Price : ${M.value}`},null,8,["class","label"])])]),_:1}),t(N,{class:"q-pt-none"},{default:a(()=>[D.value?y("",!0):(u(),_(K,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:V.value,"onUpdate:modelValue":l[9]||(l[9]=e=>V.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])),V.value&&V.value>0?(u(),_(ee,{key:1,dense:"",outlined:"",modelValue:E.value,"onUpdate:modelValue":l[10]||(l[10]=e=>E.value=e),options:S(ne),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):y("",!0)]),_:1}),n("div",el,[n("small",null,i(k.value),1)]),t(le,{align:"right"},{default:a(()=>[t(m,{flat:"",label:"Cancel",color:"red",onClick:me}),t($),V.value&&E.value?(u(),_(m,{key:0,flat:"",label:"Sale",color:"primary",onClick:fe})):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var kl=ge(ll,[["__scopeId","data-v-d14d4814"]]);export{kl as default};

import{c1 as Qe,ca as Ve,r as n,c as we,aJ as m,a6 as S,a7 as s,Q as r,u as y,a4 as Q,bb as a,d as l,a5 as q,bD as C,ad as d,N as K,F as Ce,aP as Ne,bE as g}from"./index.fa4385c5.js";import{Q as W,a as X}from"./QToolbar.816160ea.js";import{Q as I,b as O}from"./QCard.4da288be.js";import{Q as D}from"./QInput.9694c633.js";import{Q as Pe,c as A,d as Z}from"./QSpace.24bc44b2.js";import{o as ee,n as Y,l as le,j as T,k as p}from"./rtl.f6ac1500.js";import{Q as xe}from"./QSeparator.438186f9.js";import{Q as $e}from"./QBtnGroup.a0b376e3.js";import{a as De}from"./use-quasar.0d0cec89.js";import{a as Ae,u as F}from"./index.b8dd7cb3.js";import{h as Be}from"./moment.9709ab41.js";import{p as Ee}from"./product_columns.133b4496.js";import{u as Me}from"./auth-store.08242815.js";import{u as Ie}from"./product-store.097a19da.js";import{u as Oe}from"./payment-mode-store.3e3f4c80.js";import{u as Te}from"./sale-store.78aa34e5.js";import{u as Ue}from"./debtor-store.8aa7ffe1.js";import{h as Le}from"./helpers.22d5b68c.js";import{e as ze}from"./receipt.97fda6ac.js";import"./module_calls.606d4328.js";import"./_commonjsHelpers.6150b38b.js";const Re=Qe("operation",{state:()=>({selected_products:[]}),actions:{}});const Ye={class:"q-pa-md"},Fe={class:"row",style:{overflow:"hidden"}},He={class:"q-pa-xs col-xs-12 col-sm-6 col-md-7",style:{overflow:"auto"}},je={style:{color:"red"}},Ge={key:0},Je={key:1},Ke=["onClick"],We={style:{color:"#017951"}},Xe=s("hr",null,null,-1),Ze=s("hr",null,null,-1),el=s("br",null,null,-1),ll=s("br",null,null,-1),tl=s("br",null,null,-1),al={key:0,class:"q-pa-xs col-xs-12 col-sm-6 col-md-5",style:{overflow:"auto"}},ol={style:{color:"orange"}},sl={style:{color:"black"}},ul={style:{color:"black"}},rl=s("br",null,null,-1),nl=s("hr",null,null,-1),il={class:"text-h6"},dl={class:"text-center error_msg"},cl=s("div",{class:"text-h6"},"Make Payment",-1),ml={class:"q-mt-sm"},pl={key:2,class:"q-pa-sm"},_l={class:"row q-col-gutter-sm"},vl={key:3,class:"q-pt-sm"},fl={class:"text-center error_msg"},Tl={__name:"Operations",setup(bl){const B=Me(),H=Ve(),te=De(),j=Ae(),ae=Ie(),oe=Oe(),G=Te(),se=Ue(),ue=Re(),k=n(!1),V=n(!1),N=n(!1),P=n(!0),U=n(""),_=n(1),w=n(1),L=n(1),z=n(1),x=n(""),v=n(""),re=n(""),f=n(""),E=n(""),b=n("");let i=ue.selected_products;const{data:ne,isLoading:ie,isError:J}=F("products",()=>ae.fetchProducts()),{data:de}=F("payment_modes",()=>oe.fetchPaymentModes());let M=[];F("debtors",()=>se.fetchDebtors(),{onSuccess:o=>{M=o.map(t=>({name:t.name,uuid:t.uuid}))}});const R=n(M),ce=n(null),me=(o,t)=>{if(o===""){t(()=>{R.value=M});return}t(()=>{const e=o.toLowerCase();R.value=M.filter(c=>c.name.toLowerCase().indexOf(e)>-1)})},pe=o=>{o.quantity<1?(f.value=`${o.name} quantity is zero. Add more from INVENTORIES.`,E.value=`${o.name} quantity is zero. Add more from INVENTORIES.`,h(`${o.name} quantity is zero. Add more from INVENTORIES`,"red","top")):(f.value="",E.value="",i.some(t=>t.name==o.name)?(f.value="Product already added to the bill! Select a different product.",E.value="Product already added to the bill! Select a different product.",h(`${o.name} already added to the bill!`,"red","top")):(N.value=!0,b.value=o))},_e=()=>{V.value=!0},ve=()=>{N.value=!1,b.value="",_.value=1},fe=()=>{if(_.value>b.value.quantity)f.value=`${_.value} is more than the maximum available quantity`,h(`${_.value} is more than the maximum available quantity`,"red","top");else{const o={uuid:b.value.uuid,name:b.value.name,price:b.value.selling_price,quantity:_.value};i.push(o),h(`${b.value.name} added to cart!`,"green","top"),N.value=!1,b.value="",_.value=1}},$=we(()=>{let o=0;return i.forEach(t=>{o+=t.quantity*t.price}),o}),be=o=>i.splice(o,1),ye=()=>{confirm("Are you sure?")&&i.splice(0,i.length)},he=async()=>{k.value=!0;let o=[];i.forEach(e=>o.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const t={products:o,payment_mode_uuid:v.value.uuid,bill_status:"sold",debtor_uuid:x.value.uuid};if(v.value.name==="Mpesa & Cash"){const e=Number(L.value)+Number(z.value);t.selling_price=e,t.actual_selling_price=e}else P.value?(t.selling_price=Number($.value),t.actual_selling_price=Number($.value)):(t.selling_price=Number($.value),t.actual_selling_price=Number(w.value));if(t.selling_price&&t.payment_mode_uuid)if(v.value.name==="Debt"&&!x.value)alert("Debtor name is required."),f.value="Debtor name is required.",k.value=!1;else{const e=await G.createSaleOperation(t);e.status==="success"?(j.refetchQueries("products"),v.value="",_.value="",x.value="",V.value=!1,i.splice(0,i.length),k.value=!1,H.push("/bills"),h(e.message,"green","top")):(f.value=e.message,h(e.message,"red","top-right"))}else f.value="Name is required!",h("Name is required!","red","top-right")},ge=async()=>{var e;k.value=!0;let o=[];if(confirm("Are you sure?")){i.forEach(u=>o.push({name:u.name,quantity:u.quantity,uuid:u.uuid}));const c={products:o};if((e=c==null?void 0:c.products)!=null&&e.length){const u=await G.createHoldBillOperation(c);u.status==="success"?(j.refetchQueries("products"),v.value="",_.value="",V.value=!1,i.splice(0,i.length),k.value=!1,H.push("/bills"),h(u.message,"green","top")):(f.value=u.message,h(u.message,"red","top-right"))}else f.value="Name is required!",h("Name is required!","red","top-right")}},qe=()=>{V.value=!1,_.value="",re.value="",f.value=""},h=(o,t,e)=>{te.notify({message:o,color:t,position:e})},ke=()=>{var e,c;const o=[];i.forEach(u=>{o.push({name:u.name,quantity:u.quantity,price:Number(u.price),total:Number(u.quantity)*Number(u.price)})});const t={title:"Sales Receipt",bill_ref:"New Bill",created_at:Be().format("MM ddd, YYYY HH:mm:ss a"),status:"Pending Payment",user:(c=(e=B==null?void 0:B.user)==null?void 0:e.user)==null?void 0:c.name,payment_mode:"No Payment Mode",actual_selling_price:o.reduce((u,Se)=>u+Se.total,0),debtor_name:"No Debtor"};ze(o,["name","quantity","price","total"],t)};return(o,t)=>(m(),S("div",Ye,[s("div",Fe,[s("div",He,[s("small",je,r(E.value),1),y(ie)?(m(),S("div",Ge,"Loading products...")):y(J)?(m(),S("div",Je,"An error has occurred: "+r(y(J)),1)):(m(),Q(Pe,{key:2,title:"Make Sale (All Products)",rows:y(ne),columns:y(Ee),separator:"cell","row-key":"name",filter:U.value,dense:"",grid:""},{item:a(e=>[s("div",{class:"q-pa-xs col-xs-12 col-sm-6 col-md-4",onClick:c=>pe(e.row)},[l(I,{bordered:"",class:K(["selected_product",`${e.row.quantity<1?"minQty":""}`])},{default:a(()=>[l(O,{class:"text-center"},{default:a(()=>[s("strong",We,[l(C,{name:"bubble_chart"}),d(" "+r(e.row.name),1)]),Xe,s("small",null,[s("i",null,[d("Selling Price: "),s("b",null,"Ksh "+r(e.row.selling_price),1)])]),Ze,s("small",null,[s("i",null,"Category: "+r(e.row.category),1)]),el,s("small",null,[s("i",null,"Department: "+r(e.row.department),1)]),ll,s("small",null,[l(W,{color:`${e.row.quantity<1?"red":"orange"}`},{default:a(()=>[d("Available Quantity "),tl,d(r(e.row.quantity)+" "+r(e.row.measurement),1)]),_:2},1032,["color"])])]),_:2},1024)]),_:2},1032,["class"])],8,Ke)]),"top-right":a(()=>[l(D,{borderless:"",dense:"",outlined:"",rounded:"",debounce:"300",modelValue:U.value,"onUpdate:modelValue":t[0]||(t[0]=e=>U.value=e),placeholder:"Search product...",class:"q-mr-md"},{append:a(()=>[l(C,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["rows","columns","filter"]))]),y(i).length>0?(m(),S("div",al,[l(I,{bordered:""},{default:a(()=>[l(Y,null,{default:a(()=>[s("i",null,[l(C,{name:"shopping_cart"}),d(" New Bill")]),d(),l(A),s("span",ol,"(Items: "+r(y(i).length)+")",1)]),_:1}),l(O,null,{default:a(()=>[s("small",null,[l(le,{bordered:"",separator:"",dense:"",class:"bill"},{default:a(()=>[l(T,null,{default:a(()=>[l(p,null,{default:a(()=>[d("Name")]),_:1}),l(p,{style:{color:"white"}},{default:a(()=>[d("Price")]),_:1}),l(p,{style:{color:"white"}},{default:a(()=>[d("Quantity")]),_:1}),l(p,{side:"",style:{color:"white"}},{default:a(()=>[d("Total")]),_:1}),l(p,{avatar:""},{default:a(()=>[l(C,{class:"select_list",name:"delete",dense:"",color:"white",onClick:ye})]),_:1})]),_:1})]),_:1}),l(le,{bordered:"",separator:"",dense:""},{default:a(()=>[(m(!0),S(Ce,null,Ne(y(i),(e,c)=>(m(),Q(T,{key:e.uuid},{default:a(()=>[l(p,null,{default:a(()=>[d(r(e.name),1)]),_:2},1024),l(p,null,{default:a(()=>[s("span",sl,r(e.price),1)]),_:2},1024),l(p,null,{default:a(()=>[d(r(e.quantity),1)]),_:2},1024),l(p,{side:""},{default:a(()=>[s("span",ul,r(e.price*e.quantity),1)]),_:2},1024),l(p,{avatar:""},{default:a(()=>[l(C,{class:"select_list",name:"delete",dense:"",color:"red",onClick:u=>be(c)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),l(xe,{color:"orange"}),l(T,null,{default:a(()=>[l(p,null,{default:a(()=>[d("Total")]),_:1}),l(p,{avatar:""},{default:a(()=>[d(r($.value),1)]),_:1}),l(p,{avatar:""})]),_:1})]),_:1})]),rl,l($e,{spread:"",rounded:""},{default:a(()=>{var e,c,u;return[y(Le)((u=(c=(e=y(B))==null?void 0:e.user)==null?void 0:c.user)==null?void 0:u.roles)?(m(),Q(g,{key:0,size:"sm",color:"primary",label:"Sale",icon:"grain",onClick:_e})):q("",!0),l(g,{size:"sm",color:"orange",label:"Hold Bill",icon:"pan_tool",onClick:ge,loading:k.value},null,8,["loading"])]}),_:1}),nl,l(g,{color:"primary",flat:"",class:"full-width",label:"Print Bill",icon:"print",onClick:ke})]),_:1})]),_:1})])):q("",!0)]),l(ee,{modelValue:N.value,"onUpdate:modelValue":t[2]||(t[2]=e=>N.value=e),persistent:""},{default:a(()=>[l(I,{style:{width:"500px"}},{default:a(()=>[l(X,null,{default:a(()=>[s("div",il,[l(C,{name:"bubble_chart"}),d(" "+r(b.value.name),1)]),l(A),s("small",null,[l(W,null,{default:a(()=>[d(r(b.value.measurement),1)]),_:1})])]),_:1}),l(O,{class:"q-pt-none"},{default:a(()=>[l(D,{autofocus:"",outlined:"",dense:"",label:"Product Quantity",modelValue:_.value,"onUpdate:modelValue":t[1]||(t[1]=e=>_.value=e),type:"number",hint:`Note : You can sale a maximum of ${b.value.quantity}`},null,8,["modelValue","hint"])]),_:1}),s("div",dl,[s("small",null,r(f.value),1)]),l(Y,{align:"right"},{default:a(()=>[l(g,{flat:"",label:"Cancel",color:"red",onClick:ve}),l(A),_.value?(m(),Q(g,{key:0,flat:"",label:"Add Product",color:"primary",onClick:fe})):q("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ee,{modelValue:V.value,"onUpdate:modelValue":t[10]||(t[10]=e=>V.value=e),persistent:""},{default:a(()=>[l(I,{style:{width:"500px"}},{default:a(()=>[l(X,null,{default:a(()=>[cl,l(A),s("small",ml,[l(g,{disabled:v.value.name==="Mpesa & Cash",size:"sm",dense:"",color:"blue",depressed:"",class:K(`${P.value?"":"actual_selling_price"}`),onClick:t[3]||(t[3]=e=>P.value=!P.value),label:`Expected Selling Price : ${$.value}`},null,8,["disabled","class","label"])])]),_:1}),l(O,{class:"q-pt-none"},{default:a(()=>[!P.value&&v.value.name!=="Mpesa & Cash"?(m(),Q(D,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:w.value,"onUpdate:modelValue":t[4]||(t[4]=e=>w.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):q("",!0),w.value&&w.value>0?(m(),Q(Z,{key:1,dense:"",outlined:"",modelValue:v.value,"onUpdate:modelValue":t[5]||(t[5]=e=>v.value=e),options:y(de),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):q("",!0),v.value.name==="Mpesa & Cash"?(m(),S("div",pl,[s("div",_l,[l(D,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:L.value,"onUpdate:modelValue":t[6]||(t[6]=e=>L.value=e)},null,8,["modelValue"]),l(D,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:z.value,"onUpdate:modelValue":t[7]||(t[7]=e=>z.value=e)},null,8,["modelValue"])])])):q("",!0),v.value.name==="Debt"?(m(),S("div",vl,[l(Z,{outlined:"",clearable:"",dense:"",modelValue:x.value,"onUpdate:modelValue":t[8]||(t[8]=e=>x.value=e),"use-input":"","input-debounce":"0",label:"Select debtor",options:R.value,"option-value":"uuid","option-label":"name",onFilter:me,behavior:"menu",onOnchange:t[9]||(t[9]=e=>o.$emit("selectDebtor",ce.value)),hint:"Type in debtor name to filter..."},{"no-option":a(()=>[l(T,null,{default:a(()=>[l(p,{class:"text-grey"},{default:a(()=>[l(g,{size:"sm",outline:"",label:"No results? CLick here to create new debtor.",to:"/debtors",color:"primary"})]),_:1})]),_:1})]),_:1},8,["modelValue","options"])])):q("",!0)]),_:1}),s("div",fl,[s("small",null,r(f.value),1)]),l(Y,{align:"right"},{default:a(()=>[l(g,{flat:"",label:"Cancel",color:"red",onClick:qe}),l(A),w.value&&v.value?(m(),Q(g,{key:0,flat:"",label:"Sale",color:"primary",onClick:he,loading:k.value},null,8,["loading"])):q("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{Tl as default};

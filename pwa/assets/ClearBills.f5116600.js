import{c9 as me,r as d,c as _e,aJ as c,a6 as y,u as C,Q as i,a4 as b,bb as t,d as a,bE as h,bD as W,a7 as n,N as T,ad as u,a5 as f,F as X,aP as Y,aM as be,aK as fe}from"./index.dd34d1b3.js";import{Q as Z}from"./QBtnGroup.13dd3f47.js";import{Q as k}from"./QInput.4b988aaf.js";import{Q as pe,c as F,d as ye}from"./QSpace.de21bdc2.js";import{Q as I}from"./QSeparator.4ba7cdcd.js";import{Q as ve,a as ge}from"./QToolbar.43a05758.js";import{o as he,l as U,j as S,k as r,n as we}from"./rtl.bfa9a4fe.js";import{b as V,Q as ee}from"./QCard.0409bdf8.js";import{a as qe}from"./use-quasar.a3a7a307.js";import{u as Qe}from"./sale-store.9260ba94.js";import{u as Ce}from"./product-store.451eb0bb.js";import{u as ke}from"./payment-mode-store.225a2549.js";import{a as Se,u as z}from"./index.258a485c.js";import{e as Ve}from"./receipt.41c877f9.js";import{u as xe}from"./auth-store.636ace30.js";import{h as Pe}from"./helpers.d6d0b5ed.js";import"./module_calls.eba83624.js";import"./_commonjsHelpers.6150b38b.js";const x=P=>(be("data-v-41be2de7"),P=P(),fe(),P),Be={class:"q-pa-md"},De={key:0},Ne={key:1},Me={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Ie={class:"text-center"},Ue={class:"text-center"},Ae=x(()=>n("br",null,null,-1)),$e=x(()=>n("br",null,null,-1)),Ee=x(()=>n("b",null,"Payment Records (Partially Paid)",-1)),Le=x(()=>n("br",null,null,-1)),Te={key:0},Fe=x(()=>n("div",{class:"text-h6"},"Make Payment",-1)),ze={class:"q-mt-sm"},Ke={key:2,class:"q-pa-sm"},Re={class:"row q-col-gutter-sm"},je={key:3,class:"q-pa-sm"},Ge={class:"text-center error_msg"},Je={__name:"ClearBills",setup(P){const le=xe(),ae=Se(),te=qe(),A=d(""),K=Qe(),se=Ce(),ue=ke();d(!1);const B=d(!1),w=d(!0),q=d(!1),ne=d(1),v=d(1),$=d(1),E=d(1),R=d(""),g=d("");d("");const m=d(""),D=d(""),j=d([]),G=d([]),{data:Oe,isLoading:oe,isError:J}=z("bills",()=>K.fetchUnclearedBills(),{onSuccess:s=>{G.value=s.map(e=>({user:e.user,uuid:e.uuid,bill_ref:e.bill_ref,debtor_name:e.debtor_name,debtors:e.debtors,total_debt_paid:e.total_debt_paid,status:e.status,payment_mode:e.payment_mode,selling_price:e.selling_price,actual_selling_price:e.actual_selling_price,created_at:e.created_at,sales:e.sales}))}});z("products",()=>se.fetchProducts(),{onSuccess:s=>{j.value=s.map(e=>({uuid:e.uuid,name:e.name,price:e.selling_price,category:e.category,department:e.department,quantity:e.quantity}))}});const O=d([]);z("payment_modes",()=>ue.fetchPaymentModes(),{onSuccess:s=>O.value=s.filter(e=>e.name!=="Debt")}),d(j.value);const N=_e(()=>{let s=0;return g.value.sales.forEach(e=>{s+=e.selling_price*e.quantity}),s=s-g.value.total_debt_paid,s}),ie=s=>{g.value=s,q.value=!0},re=()=>{q.value=!1,m.value="",D.value=""},de=async()=>{B.value=!0;let s=[];g.value.sales.forEach(l=>s.push({name:l.name,quantity:l.quantity,uuid:l.uuid}));const e={bill_uuid:g.value.uuid,payment_mode_uuid:m.value.uuid,debtor_name:g.value.debtor_name};if(m.value.name==="Mpesa & Cash"){const l=Number($.value)+Number(E.value);e.selling_price=l,e.actual_selling_price=l}else w.value?(e.selling_price=Number(N.value),e.actual_selling_price=Number(N.value)):(e.selling_price=Number(N.value),e.actual_selling_price=Number(v.value));if(e.actual_selling_price===e.selling_price?e.balance=0:e.balance=e.selling_price-e.actual_selling_price,e.actual_selling_price&&e.payment_mode_uuid&&e.debtor_name){const l=await K.payUnclearedBill(e);l.status==="success"?(ae.refetchQueries("bills"),m.value="",ne.value="",q.value=!1,B.value=!1,L(l.message,"green","top")):(D.value=l.message,L(l.message,"red","top-right"))}else B.value=!1,D.value="Name is required!",L("Name is required!","red","top-right")},ce=s=>{const e=[];s.sales.forEach(p=>{e.push({name:p.name,quantity:p.quantity,price:p.selling_price,total:p.quantity*p.selling_price})});const l={title:"Sales Receipt",bill_ref:s.bill_ref,created_at:s.created_at,status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode,actual_selling_price:s.actual_selling_price,debtor_name:s.debtor_name};Ve(e,["name","quantity","price","total"],l)},L=(s,e,l)=>{te.notify({message:s,color:e,position:l})};return(s,e)=>(c(),y("div",Be,[C(oe)?(c(),y("div",De,"Loading bills...")):C(J)?(c(),y("div",Ne,"An error has occurred: "+i(C(J)),1)):(c(),b(pe,{key:2,grid:"",flat:"",bordered:"",title:"Uncleared Bills",rows:G.value,"row-key":"bill_ref",filter:A.value},{"top-right":t(()=>[a(Z,{class:"q-mr-sm q-mb-sm"},{default:t(()=>[a(h,{icon:"list",size:"sm",color:"primary",label:"All Bills",to:"/bills"})]),_:1}),a(k,{dense:"",debounce:"300",outlined:"",modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=l=>A.value=l),placeholder:"Search"},{append:t(()=>[a(W,{name:"search"})]),_:1},8,["modelValue"])]),item:t(l=>[n("div",Me,[a(ee,{bordered:"",class:T(`${l.row.status=="pending"?"sale_pending":""}`)},{default:t(()=>{var p,H;return[n("div",{class:T(["text-center q-pa-xs",`${l.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[n("small",null,[n("strong",null,[a(W,{name:"description",style:{"margin-bottom":"2px"}}),u(" BILL-"+i(l.row.bill_ref),1)])])],2),a(V,null,{default:t(()=>[n("div",Ie,[n("strong",null," Created by : "+i(l.row.user),1),a(F)]),a(I,{class:"q-mb-sm"}),n("div",Ue,[n("small",null,"Created On : "+i(l.row.created_at),1),u(),Ae,n("small",null,[a(ve,{color:"blue"},{default:t(()=>[u("Status : "+i(l.row.status)+" ",1),$e,u(" Mode : "+i(l.row.payment_mode),1)]),_:2},1024)])]),a(I,{class:"q-mb-sm"}),n("small",null,[a(U,{dense:"",bordered:"",separator:"",class:"debt_bill"},{default:t(()=>[a(S,null,{default:t(()=>[a(r,null,{default:t(()=>[u("Name")]),_:1}),a(r,null,{default:t(()=>[u("Price")]),_:1}),a(r,{style:{color:"white"}},{default:t(()=>[u("Quantity")]),_:1}),a(r,{style:{color:"white"}},{default:t(()=>[u("Total")]),_:1}),l.row.status==="pending"&&l.row.sales.length>1?(c(),b(r,{key:0},{default:t(()=>[u("Action")]),_:1})):f("",!0)]),_:2},1024)]),_:2},1024)]),n("small",null,[a(U,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),y(X,null,Y(l.row.sales,(o,_)=>(c(),b(S,{key:_},{default:t(()=>[a(r,null,{default:t(()=>[u(i(o.name),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i(o.selling_price),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i(o.quantity),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i((o.quantity*o.selling_price).toFixed(2)),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])]),_:2},1024),a(I),((H=(p=l==null?void 0:l.row)==null?void 0:p.debtors)==null?void 0:H.length)>0?(c(),b(V,{key:0},{default:t(()=>[n("small",null,[Ee,a(U,{dense:"",bordered:"",separator:""},{default:t(()=>[a(S,null,{default:t(()=>[a(r,null,{default:t(()=>[u("Paid")]),_:1}),a(r,null,{default:t(()=>[u("Balance")]),_:1}),a(r,null,{default:t(()=>[u("Mode")]),_:1}),a(r,null,{default:t(()=>[u("Date")]),_:1})]),_:1})]),_:1}),a(U,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),y(X,null,Y(l.row.debtors,(o,_)=>(c(),b(S,{key:_},{default:t(()=>[a(r,null,{default:t(()=>[u(i(o.amount_paid),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i(o.balance),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i(o.payment_mode),1)]),_:2},1024),a(r,null,{default:t(()=>[u(i(o.created_at),1)]),_:2},1024)]),_:2},1024))),128)),a(S,{class:"bg-indigo text-white"},{default:t(()=>[a(r,null,{default:t(()=>[u("Total Debt Cleared")]),_:1}),a(r,null,{default:t(()=>{var o;return[u(i((o=l==null?void 0:l.row)==null?void 0:o.total_debt_paid),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):f("",!0),a(I),a(V,{class:"text-center"},{default:t(()=>{var o,_,Q,M;return[n("small",null,[n("p",null,"Debtor: "+i(l.row.debtor_name),1),n("b",null,"Initial Debt Ksh "+i((o=l==null?void 0:l.row)==null?void 0:o.selling_price),1),u(),Le,((_=l==null?void 0:l.row)==null?void 0:_.total_debt_paid)>0?(c(),y("b",Te,"Amount due Ksh "+i(((Q=l==null?void 0:l.row)==null?void 0:Q.selling_price)-((M=l==null?void 0:l.row)==null?void 0:M.total_debt_paid)),1)):f("",!0)])]}),_:2},1024),a(V,{style:{padding:"0"}},{default:t(()=>[a(Z,{class:"full-width"},{default:t(()=>{var o,_,Q;return[a(h,{class:"full-width",dense:"",flat:"",onClick:M=>ce(l.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),C(Pe)((Q=(_=(o=C(le))==null?void 0:o.user)==null?void 0:_.user)==null?void 0:Q.roles)?(c(),b(h,{key:0,dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Clear Bill",icon:"grain",onClick:M=>ie(l.row)},null,8,["onClick"])):f("",!0)]}),_:2},1024)]),_:2},1024)]}),_:2},1032,["class"])])]),_:1},8,["rows","filter"])),a(he,{modelValue:q.value,"onUpdate:modelValue":e[7]||(e[7]=l=>q.value=l),persistent:""},{default:t(()=>[a(ee,{style:{width:"500px"}},{default:t(()=>[a(ge,null,{default:t(()=>[Fe,a(F),n("small",ze,[a(h,{disabled:m.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:T(`${w.value?"":"actual_selling_price"}`),onClick:e[1]||(e[1]=l=>w.value=!w.value),label:`Full payment : ${N.value}`},null,8,["disabled","class","label"])])]),_:1}),a(V,{class:"q-pt-none"},{default:t(()=>[!w.value&&m.value.name!=="Mpesa & Cash"?(c(),b(k,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual amount paid",modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=l=>v.value=l),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number",min:"1",oninput:"validity.valid||(value='');"},null,8,["modelValue"])):f("",!0),v.value&&v.value>0?(c(),b(ye,{key:1,dense:"",outlined:"",modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=l=>m.value=l),options:O.value,"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):f("",!0),m.value.name==="Mpesa & Cash"?(c(),y("div",Ke,[n("div",Re,[a(k,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",min:"1",oninput:"validity.valid||(value='');",modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=l=>$.value=l)},null,8,["modelValue"]),a(k,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",min:"1",oninput:"validity.valid||(value='');",modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=l=>E.value=l)},null,8,["modelValue"])])])):f("",!0),m.value.name==="Debt"?(c(),y("div",je,[a(k,{outlined:"",modelValue:R.value,"onUpdate:modelValue":e[6]||(e[6]=l=>R.value=l),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):f("",!0)]),_:1}),n("div",Ge,[n("small",null,i(D.value),1)]),a(we,{align:"right"},{default:t(()=>[a(h,{flat:"",label:"Cancel",color:"red",onClick:re}),a(F),v.value&&m.value?(c(),b(h,{key:0,flat:"",label:"Pay",color:"primary",onClick:de,loading:B.value},null,8,["loading"])):f("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var _l=me(Je,[["__scopeId","data-v-41be2de7"]]);export{_l as default};
